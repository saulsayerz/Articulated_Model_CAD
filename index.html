<!DOCTYPE html>
<html>

<head>
  <title>Tubes 3 Grafkom</title>
  <!-- vertex shader -->
  <script id="vertex-shader-3d" type="x-shader/x-vertex">
      attribute vec4 a_position;
      attribute vec3 a_normal;
      attribute vec4 a_color;
      attribute vec2 aTexCoord;
      
      uniform mat4 u_normal;
      uniform mat4 u_modelMatrix;
      uniform mat4 u_projMatrix;
      uniform mat4 u_viewMatrix;
      uniform float u_fudgeFactor;
      
      varying highp vec3 v_lighting;
      varying lowp vec4 v_color;

      varying vec3 vWorldNormal;
      varying vec3 vWorldPosition;
      varying vec2 vTexCoord;  
      
      void main() {
        // Multiply the position by the matrix.
        gl_Position = u_projMatrix * u_viewMatrix * u_modelMatrix * a_position;

        // Adjust the z to divide by
        float zToDivideBy = 1.0 + gl_Position.z * u_fudgeFactor;
      
        // Divide x and y by z.
        gl_Position = vec4(gl_Position.xy / zToDivideBy, gl_Position.zw);
        
        // Pass the color to the fragment shader.
        v_color = a_color;
        vTexCoord = aTexCoord;

        highp vec3 ambient_light = vec3(0.5, 0.5, 0.5);
        highp vec3 directional_light_color = vec3(1, 1, 1);
        highp vec3 directional_light_direction = vec3(0.85, 0.8, 0.75);
        highp vec4 transformed_normal = u_normal * vec4(a_normal, 1.0);
      
        highp float directional = max(dot(transformed_normal.xyz, directional_light_direction), 0.0);
        v_lighting = ambient_light + (directional_light_color * directional);
        
        vWorldNormal = normalize(mat3(u_modelMatrix) * a_normal);
        vWorldPosition = (u_modelMatrix * a_position).xyz;
      }
    </script>
  <!-- fragment shader -->
  <script id="fragment-shader-3d" type="x-shader/x-fragment">
      #extension GL_OES_standard_derivatives : enable  
      precision mediump float;
      
      // Passed in from the vertex shader.
      varying highp vec3 v_lighting;
      varying lowp vec4 v_color;
      varying vec2 vTexCoord;  
      varying vec3 vWorldNormal;
      varying vec3 vWorldPosition;  

      uniform float u_height_scale;
      
      uniform bool u_shading;
      uniform sampler2D u_image;   
      uniform samplerCube u_environment;
      uniform sampler2D u_diffuseColor;
      uniform sampler2D u_bump;
      uniform sampler2D u_displacement_map;
      uniform vec3 u_light_pos;
      uniform vec3 u_view_pos;

      uniform highp int u_texture;

      vec2 ParallaxMapping (vec2 texCoord, vec3 viewDir)
      {
          float numLayers = 32.0 - 31.0 * abs(dot(vec3(0.0, 0.0, 1.0), viewDir));
          float layerDepth = 1.0 / numLayers;

          vec2 P = viewDir.xy / viewDir.z * u_height_scale;
          vec2 deltaTexCoords = P / numLayers;
          vec2 currentTexCoords = texCoord;

          float currentLayerDepth = 0.0;
          float currentDepthMapValue = texture2D(u_displacement_map, currentTexCoords).r;
          for (int i=0; i<32; ++ i)
          {
              if (currentLayerDepth >= currentDepthMapValue)
                  break;
              currentTexCoords -= deltaTexCoords;
              currentDepthMapValue = texture2D(u_displacement_map, currentTexCoords).r;
              currentLayerDepth += layerDepth;
          }

          vec2 prevTexCoords = currentTexCoords + deltaTexCoords;
          float afterDepth = currentDepthMapValue - currentLayerDepth;
          float beforeDepth = texture2D(u_displacement_map, prevTexCoords).r - currentLayerDepth + layerDepth;

          float weight = afterDepth / (afterDepth - beforeDepth);
          return prevTexCoords * weight + currentTexCoords * (1.0 - weight);
      }
      
      void main() {
        if (u_shading) {
          gl_FragColor = vec4(v_color.rgb * v_lighting, v_color.a);
        } else if (u_texture == 1) {
          gl_FragColor = texture2D(u_image, vTexCoord);
        } else if (u_texture == 2) {
          vec3 eyeToSurfaceDir = normalize(vWorldPosition - vec3(0.0, 0.0, 0.0));
          vec3 reflectedDir = reflect(eyeToSurfaceDir, normalize(vWorldNormal));
          reflectedDir.xy *= -1.0;
          gl_FragColor = textureCube(u_environment, reflectedDir);
        } else if (u_texture == 3) {
          vec3 N = normalize(vWorldNormal);

          vec3 dp1 = dFdx(vWorldPosition);
          vec3 dp2 = dFdy(vWorldPosition);
          vec2 duv1 = dFdx(vTexCoord);
          vec2 duv2 = dFdy(vTexCoord);

          vec3 dp2perp = cross(dp2, N);
          vec3 dp1perp = cross(N, dp1);

          vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;
          vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;

          float invmax = inversesqrt(max(dot(T,T), dot(B,B)));
          mat3 tm = mat3(T * invmax, B * invmax, N);

          mat3 tbn_inv = mat3(vec3(tm[0].x, tm[1].x, tm[2].x), vec3(tm[0].y, tm[1].y, tm[2].y), vec3(tm[0].z, tm[1].z, tm[2].z));
          
          vec3 view_dir = tbn_inv * normalize(vWorldPosition - u_view_pos);
          vec2 uv = ParallaxMapping(vTexCoord, view_dir);
          if (uv.x > 1.0 || uv.y > 1.0 || uv.x < 0.0 || uv.y < 0.0)
            discard;

          vec3 L = tbn_inv * normalize(u_light_pos - vWorldPosition);
          vec3 mapN = normalize(texture2D(u_bump, uv.st).xyz * 2.0 - 1.0);
          float kd = max(dot(mapN, L), 0.0);

          vec3 color = texture2D(u_diffuseColor, uv.st).rgb;
          vec3 light_col = (0.1 + kd) * color.rgb;

          gl_FragColor = vec4(clamp(light_col, 0.0, 1.0), 1.0);
        } else {
          gl_FragColor = v_color;
        }
      }
    </script>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="src/scripts/main.js"></script>
</head>

<body>
  <!-- Modal -->
  <div id="myModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" id="closeSpan">&times;</span>
      <h1>Load Model</h1>
      <p>Memuat model dari file .json dengan format di bawah ini dan menampilkan hasil rendernya pada canvas. Load kami
        bisa memuat lebih dari satu model sehingga akan timpang tindih apabila load ada objek lain. Jika ingin mengganti
        model, dapat clear canvas terlebih dahulu saja.</p>
      <pre>
        {
          posistions: [ // vertices ],
          colors: [r, g, b, a],
          normals: [ // normal surfaces]
        }
        </pre>
      <h1>Projections</h1>
      <p>Mengubah tipe proyeksi dari tampilan 3d dengan memilih salah satu tipe proyeksi di bawah ini pada radio di
        toolbar kanan: </p>
      <h2>- Orthogonal</h2>
      <p>Program menampilkan proyeksi ini secara default</p>
      <h2>- Perspective</h2>
      <p>Untuk memilih proyeksi ini, cukup click radio button perspective. Disediakan juga slider fudge factor untuk
        menentukan ingin seberapa dekat perspektifnya</p>
      <h2>- Oblique</h2>
      <p>Untuk memilih proyeksi ini, cukup click radio button oblique. Kami menggunakan cabinet oblique.</p>

      <h1>Translate</h1>
      <p>Melakukan translasi objek 3d pada sumbu yang dipilih pada slider yang sesuai. Terdapat pilihan untuk melakukan
        translasi pada sumbu-X, sumbu-Y, dan sumbu-Z. Nilai translasi yang dapat dipilih adalah -360 sampai 360 pada
        masing-masing sumbu.</p>

      <h1>Rotate</h1>
      <p>Melakukan rotasi objek 3d pada sumbu yang dipilih pada slider yang sesuai. Terdapat pilihan untuk melakukan
        rotasi pada sumbu-X, sumbu-Y, dan sumbu-Z. Nilai rotasi yang dapat dipilih adalah -360 sampai 360 pada
        masing-masing sumbu.</p>

      <h1>Scale</h1>
      <p>Melakukan scaling objek 3d pada sumbu yang dipilih pada slider yang sesuai. Terdapat pilihan untuk melakukan
        scaling pada sumbu-X, sumbu-Y, dan sumbu-Z. Nilai scaling yang dapat dipilih adalah 0.1 sampai 10 pada
        masing-masing sumbu.</p>

      <h1>Camera</h1>
      <p>Camera dapat digunakan untuk memutari objek pada sumbu-X, sumbu-Y, dan juga sumbu-Z. Camera akan fokus pada
        titik origin (0,0,0) dan berada pada jarak radius yang juga dapat dipilih pada toolbar. Rotasi camera dapat
        dipilih antara sudut 0 sampai 360 derajat sedangkan radius camera dapat dipilih dari 1 sampai 360.</p>

      <h1>Reset</h1>
      <p>Terdapat tombol reset view yang disediakan pada toolbar untuk mengembalikan tampilan objek menjadi tampilan
        default.</p>

      <h1>Shading</h1>
      <p>Untuk melakukan shading dari suatu objek, maka bisa menekan checkbox shading yang disediakan pada toolbar.
        Checkbox bisa diklik lagi agar shading dapat dinonaktifkan.</p>

      <h1>Save</h1>
      <p>Apabila selesai melakukan transformasi dari sebuah model, maka bisa menekan tombol save yang disediakan di
        paling kanan bawah. Model terbaru akan terdownload pada perangkat pengguna dengan nama model.json </p>

      <h1>Clear Canvas</h1>
      <p>Untuk menghapus semua model yang sudah di load</p>

    </div>
  </div>
  
  <!-- ARTICULATED CANVAS -->
  <div id="flexContainer">
  
    <div class="canvasContainer">
      <canvas id="myCanvas" class="canvas"></canvas>
      <canvas id="myCanvas2" class="canvas"></canvas>
    </div>
  
    <div class="fixed-toolbar">
      <div class="toolbar">
        <div class="title">
          Select Model
        </div>
        <div id="uiContainer">
          <div id="ui">
            <div>
              <input type="file" id="file" accept=".json" />
            </div>
            <div>
              <button id="animate">Animation</button>
              <button id="save">Save</button>
              <button id="reset">Reset</button>
              <button id="help">Help</button>
              <button id="reset-component">Reset</button>
            </div>
          </div>
        </div>
        <div class="title">
          General Controls
        </div>
        <div id="uiContainer">
          <div id="ui">
            <hr>
            <div class="tools-label">PROJECTION TYPE</div>
            <div class="tools">
              <div class="outer">
                <div id="value-shading"></div>
                <input id="orthogonal" type="radio" name="perspective-option" value="orthogonal">
                <label for="orthogonal">Orthogonal</label>
                <input id="perspective" type="radio" name="perspective-option" value="perspective" checked>
                <label for="perspective">Perspective</label>
                <input id="oblique" type="radio" name="perspective-option" value="oblique">
                <label for="oblique">Oblique</label>
              </div>
            </div>
            <br>
            <div class="outer">
              <div class="label">Fudge Factor</div>
              <div id="value-fudgeFactor"></div>
              <input id="slider-fudgeFactor" type="range" min="0.1" max="5" step="0.05" value="1" />
            </div>
            <hr>
            <div class="tools-label">TRANSLATE</div>
            <div class="tools">
              <div class="outer">
                <div class="label">translation-x</div>
                <div id="value-x"></div>
                <input id="slider-x" type="range" min="-360" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">translation-y</div>
                <div id="value-y"></div>
                <input id="slider-y" type="range" min="-360" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">translation-z</div>
                <div id="value-z"></div>
                <input id="slider-z" type="range" min="-800" max="800" step="1" />
              </div>
            </div>
            <hr>
            <div class="tools-label">ROTATE</div>
            <div class="tools">
              <div class="outer">
                <div class="label">rotation-X</div>
                <div id="value-angleX"></div>
                <input id="slider-angleX" type="range" min="0" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">rotation-Y</div>
                <div id="value-angleY"></div>
                <input id="slider-angleY" type="range" min="0" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">rotation-Z</div>
                <div id="value-angleZ"></div>
                <input id="slider-angleZ" type="range" min="0" max="360" step="1" />
              </div>
            </div>
            <hr>
            <div class="tools-label">SCALE</div>
            <div class="tools">
              <div class="outer">
                <div class="label">scaling-X</div>
                <div id="value-scaleX"></div>
                <input id="slider-scaleX" type="range" min="0" max="10" step="0.1" />
              </div>
              <div class="outer">
                <div class="label">scaling-Y</div>
                <div id="value-scaleY"></div>
                <input id="slider-scaleY" type="range" min="0" max="10" step="0.1" />
              </div>
              <div class="outer">
                <div class="label">scaling-Z</div>
                <div id="value-scaleZ"></div>
                <input id="slider-scaleZ" type="range" min="0" max="10" step="0.1" />
              </div>
            </div>
            <hr>
            <div class="tools-label">CAMERA</div>
            <div class="tools">
              <div class="outer">
                <div class="label">camera</div>
                <div id="value-camera"></div>
                <input id="slider-camera" type="range" min="0" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">camera-radius</div>
                <div id="value-cameraR"></div>
                <input id="slider-cameraR" type="range" min="1" max="360" step="1" />
              </div>
            </div>
            <hr>
            <div class="tools-label">SHADING</div>
            <div class="tools">
              <div class="outer">
                <div id="value-shading"></div>
                <input id="check-shading" type="checkbox" />
              </div>
            </div>
            <hr>
            <div class="tools-label">TEXTURE</div>
            <div class="tools">
              <label for="texture-dropdown">Texture Type:</label>
              <select id="texture-dropdown">
                <option value="0">None</option>
                <option value="1">Custom</option>
                <option value="2">Environment</option>
                <option value="3">Bump</option>
              </select>
            </div>
            <hr>
          </div>
        </div>
        <div class="title">
          Component Tree
        </div>
        <div id="uiContainer">
          <div id="ui">
            <p id="selectedPart"></p>
            <div id="component-tree">
              <!-- DIISI COMPONENT TREE -->
            </div>
            <br>
          </div>
        </div>
        <div class="title">
          Component Controls
        </div>
        <div id="uiContainer">
          <div id="ui">
            <hr>
            <div class="tools-label">PROJECTION TYPE</div>
            <div class="tools">
              <div class="outer">
                <div id="value-component-shading"></div>
                <input id="orthogonal-component" type="radio" name="perspective-option" value="orthogonal">
                <label for="orthogonal-component">Orthogonal</label>
                <input id="perspective-component" type="radio" name="perspective-option" value="perspective" checked>
                <label for="perspective-component">Perspective</label>
                <input id="oblique-component" type="radio" name="perspective-option" value="oblique">
                <label for="oblique-component">Oblique</label>
              </div>
            </div>
            <br>
            <div class="outer">
              <div class="label">Fudge Factor</div>
              <div id="value-component-fudgeFactor"></div>
              <input id="slider-component-fudgeFactor" type="range" min="0.1" max="5" step="0.05" value="1" />
            </div>
            <hr>
            <div class="tools-label">TRANSLATE</div>
            <div class="tools">
              <div class="outer">
                <div class="label">translation-x</div>
                <div id="value-component-x"></div>
                <input id="slider-component-x" type="range" min="-360" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">translation-y</div>
                <div id="value-component-y"></div>
                <input id="slider-component-y" type="range" min="-360" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">translation-z</div>
                <div id="value-component-z"></div>
                <input id="slider-component-z" type="range" min="-800" max="800" step="1" />
              </div>
            </div>
            <hr>
            <div class="tools-label">ROTATE</div>
            <div class="tools">
              <div class="outer">
                <div class="label">rotation-X</div>
                <div id="value-component-angleX"></div>
                <input id="slider-component-angleX" type="range" min="0" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">rotation-Y</div>
                <div id="value-component-angleY"></div>
                <input id="slider-component-angleY" type="range" min="0" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">rotation-Z</div>
                <div id="value-component-angleZ"></div>
                <input id="slider-component-angleZ" type="range" min="0" max="360" step="1" />
              </div>
            </div>
            <hr>
            <div class="tools-label">SCALE</div>
            <div class="tools">
              <div class="outer">
                <div class="label">scaling-X</div>
                <div id="value-component-scaleX"></div>
                <input id="slider-component-scaleX" type="range" min="0" max="10" step="0.1" />
              </div>
              <div class="outer">
                <div class="label">scaling-Y</div>
                <div id="value-component-scaleY"></div>
                <input id="slider-component-scaleY" type="range" min="0" max="10" step="0.1" />
              </div>
              <div class="outer">
                <div class="label">scaling-Z</div>
                <div id="value-component-scaleZ"></div>
                <input id="slider-component-scaleZ" type="range" min="0" max="10" step="0.1" />
              </div>
            </div>
            <hr>
            <div class="tools-label">CAMERA</div>
            <div class="tools">
              <div class="outer">
                <div class="label">camera</div>
                <div id="value-component-camera"></div>
                <input id="slider-component-camera" type="range" min="0" max="360" step="1" />
              </div>
              <div class="outer">
                <div class="label">camera-radius</div>
                <div id="value-component-cameraR"></div>
                <input id="slider-component-cameraR" type="range" min="1" max="360" step="1" />
              </div>
            </div>
            <hr>
            <div class="tools-label">SHADING</div>
            <div class="tools">
              <div class="outer">
                <div id="value-component-shading"></div>
                <input id="check-component-shading" type="checkbox" />
              </div>
            </div>
            <hr>
            <div class="tools-label">TEXTURE</div>
            <div class="tools">
              <label for="texture-component-dropdown">Texture Type:</label>
              <select id="texture-component-dropdown">
                <option value="0">None</option>
                <option value="1">Custom</option>
                <option value="2">Environment</option>
                <option value="3">Bump</option>
              </select>
            </div>
            <hr>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>